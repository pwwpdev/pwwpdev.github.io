<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Second Floor Smplrspace Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
    body,
    html {
      height: 100vh !important;
      overflow: hidden;
      margin: 0;
      padding: 0;
    }
    #wrapper,
    #smplrspace-container {
      height: 100vh !important;
    }

    #mini-map-container {
  position: absolute;
  top: 0px;
  right: 0px;
  width: 360px;
  padding: 4px 4px 0px 4px;
  background: rgba(216, 216, 216, 0.956);
  backdrop-filter: blur(10px);
  border-left: 0.5px solid #d4d4d4;
  border-bottom: 0.5px solid #d4d4d4;
  border-bottom-left-radius: 4px;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
  z-index: 10;
  overflow: hidden;
}

#map-wrapper {
  position: relative;
  width: 100%;
  height: fit-content;
  overflow: hidden;
}

#mini-map {
  width: 100%;
  transform-origin: center;
  transition: transform 0.2s ease;
  cursor: move;
}

.map-controls {
  position: absolute;
  bottom: 6px;
  right: 2px;
  display: flex;
  flex-direction: row;
  gap: 10px;
  z-index: 11;
}

.control-btn {
  width: 20px;
  height: 20px;
  background: white;
  border: none;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  user-select: none;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.control-btn:hover {
  background: #f5f5f5;
}

@media (max-width: 768px) {
  #mini-map-container {
    width: 210px;
  }
  #map-wrapper {
    height: fit-content;
  }

   #legend-container {
    display: none !important;
  }
  
  .control-btn {
    width: 18px;
    height: 18px;
    font-size: 14px;
    border-radius: 2px;
  }
  .map-controls {
    gap: 6px;
  }
}

@media (max-width: 480px) {
  #mini-map-container {
    width: 140px;
  }
  #map-wrapper {
    height: fit-content;
  }
  .control-btn {
    width: 12px;
    height: 12px;
    font-size: 8px;
    border-radius: 2px;
  }
}
button[title="Hide annotations"] {
  display: none !important;
}

  </style>
  </head>
  <body>
    <script src="https://app.smplrspace.com/lib/smplr.js"></script>
    <link href="https://app.smplrspace.com/lib/smplr.css" rel="stylesheet" />
   

    <div id="wrapper">
        <div id="smplrspace-container"></div>
        <div
          id="custom-tooltip"
          style="
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border: 1px solid #ccc;
            font-family: 'Inter', sans-serif;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            max-width: 300px;
          "
        >
          <div id="tooltip-content"></div>
        </div>
      </div>
  
      <!-- Combined Legend Box -->
    <div id="legend-container" style="
    position: absolute;
    bottom: 0px;
    left: 54px;
    background: rgba(219, 218, 218, 0.492);
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    font-size: 12px;
    font-weight: 400;
    font-family: 'Inter', sans-serif;
    color: #333;
    min-width: 100px;
  ">
    <div style="padding: 5px 4px; text-align: center; border-bottom: 1px solid #ccc; margin-bottom: 4px;">
      Default View
    </div>
    <div style="padding: 5px 4px; text-align: center; border-bottom: 1px solid #ccc; margin-bottom: 4px;">
      Zoom IN
    </div>
    <div style="padding: 5px 4px; text-align: center; border-bottom: 1px solid #ccc; margin-bottom: 4px;">
      Zoom OUT
    </div>
    <div style="padding: 5px 4px; text-align: center;">
      Switch 2D/3D 
    </div>
  </div>

    <div id="mini-map-container">
        <div id="map-wrapper">
          <img id="mini-map" src="mini_2f.png" alt="Mini Map" />
        </div>
      </div>

    <script>
      // Replace with your second floor specific values
      const API_ENDPOINT =
        "https://optimusc.flowfuse.cloud/lingnan-library-dos";

      // Replace with your second floor client and space IDs
      const CLIENT_ID = "pub_45cf413215bd43f79621e0b28f8a815b";
      const SPACE_ID = "spc_vyvqclk6";

      const UPDATE_FREQUENCY = 60;

      // Keep toilet indices
      const toilet_index = {
        "2F-FT1": 0,
        "2F-FT2": 1,
        "2F-MT1": 2,
        "2F-MT2": 3,
      };

      const toilet_filter = {
        "2F-FT1": "2F-FT1",
        "2F-FT2": "2F-FT2",
        "2F-MT1": "2F-MT1",
        "2F-MT2": "2F-MT2",
      };

      // Keep non-accessible area index
      const non_accessible_area_index = {
        1: 0,
      };

      const non_accessible_area_filter = {
        NonAssessibleArea: "1",
      };

      const rooms = [];

      const color_dict = {
        occupied: "#ff3f34",
        countdown: "#ff3f34",
        vacant: "#3aa655",
        free: "#3aa655",
        unoccupied: "#3aa655",
        passive_occupied: "#ffbf00",
        away: "#ffbf00",
        demo: "#6888be",
        unavailable: "#949494",
        restricted: "#768590",
      };

      async function refreshFacilityData() {
  console.log('Refreshing facility data...');
  await fetchFacilityData();
  console.log('Facility data refreshed:', facilityAPIData);
}

// Fetch facility data from API
let facilityAPIData = null;

async function fetchFacilityData() {
  try {
    // Fetch first levels
    const response = await fetch('https://njs-01.optimuslab.space/library_facilities/');
    const data = await response.json();
    const firstLevels = data.library_facilities || [];
    
    // Fetch children for each first level
    const facilitiesWithChildren = await Promise.all(
      firstLevels.map(async (firstLevel) => {
        try {
          const childrenResponse = await fetch(
            `https://njs-01.optimuslab.space/library_facilities/children/${firstLevel.id}`
          );
          const childrenData = await childrenResponse.json();
          
          return {
            ...firstLevel,
            second_levels: childrenData.second_levels || []
          };
        } catch (err) {
          console.error(`Failed to fetch children for ${firstLevel.id}:`, err);
          return {
            ...firstLevel,
            second_levels: []
          };
        }
      })
    );
    
    facilityAPIData = facilitiesWithChildren;
    console.log('Facility data loaded:', facilityAPIData);
  } catch (error) {
    console.error('Failed to fetch facility data:', error);
    facilityAPIData = [];
  }
}

// Function to find facility info by name
function findFacilityInfo(facilityName) {
  if (!facilityAPIData) return null;
  
  // Search through all levels
  for (const firstLevel of facilityAPIData) {
    if (firstLevel.name === facilityName) {
      return {
        description: firstLevel.description,
        image: firstLevel.image,
        name: firstLevel.name
      };
    }
    
    for (const secondLevel of firstLevel.second_levels || []) {
      if (secondLevel.name === facilityName) {
        return {
          description: secondLevel.description,
          image: secondLevel.image,
          name: secondLevel.name
        };
      }
      
      for (const thirdLevel of secondLevel.third_levels || []) {
        if (thirdLevel.name === facilityName) {
          return {
            description: thirdLevel.description,
            image: thirdLevel.image,
            name: thirdLevel.name
          };
        }
      }
    }
  }
  return null;
}

// Generic facility handler
function handleGenericFacility(facilityAsset, facilityName) {
  let facilityInfo = findFacilityInfo(facilityName);
  
  if (!facilityInfo) {
    console.log('Facility not found, refreshing data...');
    refreshFacilityData().then(() => {
      facilityInfo = findFacilityInfo(facilityName);
      updateFacilityDisplay(facilityAsset, facilityName, facilityInfo);
    });
    return;
  }
  
  updateFacilityDisplay(facilityAsset, facilityName, facilityInfo);
}

// Extract display logic
function updateFacilityDisplay(facilityAsset, facilityName, facilityInfo) {
  const room = {
    id: facilityAsset.id,
    name: facilityAsset.name,
    levelIndex: facilityAsset.levelIndex,
    coordinates: facilityAsset.coordinates,
    layerType: facilityAsset.layerType,
    mapped: facilityAsset.mapped,
    height: getFacilityHeight(facilityName),
    color: "#E566FF",
    available: "Available",
    description: facilityInfo?.description || "Available for use"
  };
  
  rooms.push(room);
  
  setTimeout(() => {
    if (spc && spc.space) {
      spc.updateMapForFacility();
    }
  }, 2000);
  
  setTimeout(() => showGenericTooltip(facilityName, true), 1000); // Show skeleton immediately
}



// Get appropriate height for different facility types
function getFacilityHeight(facilityName) {
  return 3.1;
}

// Generic tooltip function using API data with image on right
// Generic tooltip function using API data
function showGenericTooltip(facilityName, showSkeleton = false) {
  const tooltipDiv = document.getElementById("custom-tooltip");
  const contentDiv = document.getElementById("tooltip-content");
  
  if (tooltipDiv && contentDiv) {
    const facilityInfo = findFacilityInfo(facilityName);
    
    // Show skeleton loading if no data available or explicitly requested
if (!facilityInfo || showSkeleton) {
  const content = `
    <div style="padding: 0; margin: 0; line-height: 1.2;">
      <div style="font-weight: bold; margin-bottom: 8px; font-size: 16px; color: #000;">${facilityName}</div>
      <div style="margin-bottom: 8px; height: 20px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px;"></div>
      <div style="width: 120px; height: 80px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; display: block;"></div>
    </div>
    <style>
      @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
    </style>
  `;
  contentDiv.innerHTML = content;
  tooltipDiv.style.display = "block";
  
  // If we have facility info but are showing skeleton (showSkeleton = true), 
  // show actual data after a brief delay
  if (facilityInfo && showSkeleton) {
    setTimeout(() => {
      showGenericTooltip(facilityName, false);
    }, 500);
  }
  // If no facility info, try to refresh data
  else if (!facilityInfo) {
    refreshFacilityData().then(() => {
      const updatedInfo = findFacilityInfo(facilityName);
      if (updatedInfo) {
        showGenericTooltip(facilityName, false);
      }
    });
  }
  return;
}
    
    // Show actual content when data is available
    const description = facilityInfo.description;
    const imageUrl = facilityInfo.image;
    
    const content = `
      <div style="padding: 0; margin: 0; line-height: 1.2;">
        <div style="font-weight: bold; margin-bottom: 8px; font-size: 16px; color: #000;">${facilityName}</div>
        <div style="margin-bottom: 8px; font-size: 14px;">${description}</div>
        <img src="${imageUrl}" 
             style="width: 120px; height: 80px; border-radius: 4px; display: block; object-fit: cover;" 
             onerror="this.style.display='none'" />
      </div>
    `;
    
    contentDiv.innerHTML = content;
    tooltipDiv.style.display = "block";
  }
}

      // Define the assets for the second floor - keep only what's needed
      const dict = [
      {
    "id": "93b14a37-7e7b-4747-bbc5-c2f5f18735d7",
    "name": "NonAssessibleArea",
    "type": "polygon",
    "assets": []
  },
  {
    "id": "83510d18-ceb2-4bec-9d23-cd9b59cf250c",
    "name": "FemaleToilet",
    "type": "polygon",
    "assets": [
      {
        "id": "424a1af4-39d2-4151-b29b-f9f18cffbf5b",
        "name": "2F-FT1",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 55.279,
              "z": -35.055,
              "levelIndex": 0
            },
            {
              "x": 55.317,
              "z": -37.932,
              "levelIndex": 0
            },
            {
              "x": 59.832,
              "z": -37.924,
              "levelIndex": 0
            },
            {
              "x": 59.907,
              "z": -35.024,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      }
    ]
  },
  {
    "id": "bca7d0da-c371-4f2c-bc50-86d3446428cc",
    "name": "MaleToilet",
    "type": "polygon",
    "assets": [
      {
        "id": "a9dcd490-f664-4f93-9cbe-43fc75be9c9c",
        "name": "2F-MT1",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 59.828,
              "z": -35.01,
              "levelIndex": 0
            },
            {
              "x": 59.894,
              "z": -37.925,
              "levelIndex": 0
            },
            {
              "x": 65.406,
              "z": -37.872,
              "levelIndex": 0
            },
            {
              "x": 65.227,
              "z": -35.154,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      }
    ]
  },
  {
    "id": "151f6d04-df83-4bc6-8525-aa0bf2ff6290",
    "name": "BookShelves",
    "type": "furniture",
    "assets": [
      {
        "id": "1727459a-e8cc-4263-8bbc-2def247d5285",
        "name": "2A01",
        "furnitureId": "c55bbbeb-3b46-416a-a0db-72da7a02c088",
        "layerType": "furniture"
      },
      {
        "id": "60accb8b-e47c-4d4f-b6ef-5a37d4a413a1",
        "name": "2A02",
        "furnitureId": "786e3c28-b5fc-4c22-a8c7-77140c8e05da",
        "layerType": "furniture"
      },
      {
        "id": "2b5a2bf9-7bd3-4ae0-8872-ff4ca0b026e9",
        "name": "2A03",
        "furnitureId": "324cb7c4-9bed-4d69-872b-a555490cca1a",
        "layerType": "furniture"
      },
      {
        "id": "0068d637-9ed9-4297-b4c4-3ef1589d8bee",
        "name": "2A04",
        "furnitureId": "cae6debd-4d18-4fc8-a4d2-e51fc7e56c2b",
        "layerType": "furniture"
      },
      {
        "id": "fbaeaa0d-cb98-4678-a2e8-752234e4989b",
        "name": "2A05",
        "furnitureId": "f8561d0d-a792-4291-976c-cd97420c9fb3",
        "layerType": "furniture"
      },
      {
        "id": "a248058a-d1b7-4260-9181-c6b8a662a91d",
        "name": "2A06",
        "furnitureId": "ac652397-6719-4761-82c8-41cd6feda332",
        "layerType": "furniture"
      },
      {
        "id": "3bcc8aeb-b7ea-4d0d-b125-140e47d27c47",
        "name": "2A07",
        "furnitureId": "94860a18-4475-4d98-9171-b72638dcf712",
        "layerType": "furniture"
      },
      {
        "id": "e260d647-69c9-4d22-873f-e9a56381e836",
        "name": "2A08",
        "furnitureId": "6cb338b0-3cd9-413d-af3f-e38b6469809c",
        "layerType": "furniture"
      },
      {
        "id": "50a90140-ba34-4c64-b39a-33d60bc7a4d3",
        "name": "2A09",
        "furnitureId": "917cd55f-143a-46b9-931a-668e2c516aac",
        "layerType": "furniture"
      },
      {
        "id": "4115810e-573f-4c66-91fd-74ed0186ae09",
        "name": "2A10",
        "furnitureId": "3a7974f2-15a0-4c62-b3c3-40361aa43c16",
        "layerType": "furniture"
      },
      {
        "id": "02adc9df-0fd7-485b-ac1d-f06e672079e7",
        "name": "2A11",
        "furnitureId": "96e21748-6676-46db-ab9d-6c7b1f92200c",
        "layerType": "furniture"
      },
      {
        "id": "26102806-3235-4c08-9bc1-2632cad41e1e",
        "name": "2A12",
        "furnitureId": "9f31aafd-20f2-4866-8433-bc4b3baf51f0",
        "layerType": "furniture"
      },
      {
        "id": "020c961b-4e35-4c23-bda1-044efb59ac05",
        "name": "2A13",
        "furnitureId": "67e72ce6-c7ae-495e-a118-abb105a7e536",
        "layerType": "furniture"
      },
      {
        "id": "3e466842-9de8-49c3-b020-e6ec3a0fded5",
        "name": "2A14",
        "furnitureId": "fc91e751-f7b3-4856-92cd-89ddbcba1c02",
        "layerType": "furniture"
      },
      {
        "id": "b00235d4-d5a3-4bdb-9ee1-d481fcfac7e0",
        "name": "2A15",
        "furnitureId": "872efea0-72f9-4f09-9e81-88ba15c8271e",
        "layerType": "furniture"
      },
      {
        "id": "339d7ec5-8a3e-47a6-a27c-ecb75791c428",
        "name": "2A16",
        "furnitureId": "960c01a1-7ae3-45c2-9eda-3023b6442fa2",
        "layerType": "furniture"
      },
      {
        "id": "0cc0920b-f058-4aa9-81aa-fc52fd995317",
        "name": "2B01",
        "furnitureId": "92a9b2ac-cdfa-479f-8dda-6635d58bf1ba",
        "layerType": "furniture"
      },
      {
        "id": "6b29764c-ec9c-4c2e-9fbd-f2e5aba99ed1",
        "name": "2B02",
        "furnitureId": "b2766e86-0806-4007-8ade-23aa0c6f506d",
        "layerType": "furniture"
      },
      {
        "id": "3999a195-727f-4c0d-97d8-c18a91eb950a",
        "name": "2B03",
        "furnitureId": "2418b769-ef4d-4477-ae6e-0ca4de40149f",
        "layerType": "furniture"
      },
      {
        "id": "ec949863-6901-4c9c-b81b-2746fff018c5",
        "name": "2C01",
        "furnitureId": "145e5cc3-397e-4033-8e31-ece819adacae",
        "layerType": "furniture"
      },
      {
        "id": "1d015d63-1ceb-4687-a73e-5a1fb6f6611f",
        "name": "2C02",
        "furnitureId": "0cfea22c-3348-48a1-8594-71c13f39bf1b",
        "layerType": "furniture"
      },
      {
        "id": "8cfaa9f7-0f23-4700-9a57-70272590ecec",
        "name": "2C03",
        "furnitureId": "74064f90-d461-41c6-8028-227d1d00e141",
        "layerType": "furniture"
      },
      {
        "id": "c7b2de7d-0c7f-470b-b9b6-d6e076e0d0e1",
        "name": "2C04",
        "furnitureId": "9fab116b-2659-4d02-81e4-bc73a85e7ba2",
        "layerType": "furniture"
      },
      {
        "id": "4e3187fb-c4f9-4be3-a599-9276615d23ef",
        "name": "2C05",
        "furnitureId": "3ef34bab-a2cb-4f02-b4a0-1965d7397a3c",
        "layerType": "furniture"
      },
      {
        "id": "e63233e1-c9aa-40fe-8eb1-f9840763dbad",
        "name": "2C06",
        "furnitureId": "2a11f3db-70ca-4c30-9f3a-4405bbfb17f0",
        "layerType": "furniture"
      },
      {
        "id": "e90f59a3-46fd-48b9-857d-11271ab512f9",
        "name": "2C07",
        "furnitureId": "9d6357e7-38e5-4cb3-ac37-49030cec0e8a",
        "layerType": "furniture"
      },
      {
        "id": "d7a94605-10d4-4185-b4c3-90f5834f67a1",
        "name": "2C08",
        "furnitureId": "2458dc8d-a511-45b9-a7e4-4725910e0e11",
        "layerType": "furniture"
      },
      {
        "id": "0b3184e4-2c23-4b50-9cc8-bdcb2b2b0f0b",
        "name": "2C09",
        "furnitureId": "12a84d00-67fa-429e-8894-a9eec7482196",
        "layerType": "furniture"
      },
      {
        "id": "94b5b0fe-701c-4604-ac8d-c3e53a45966d",
        "name": "2C10",
        "furnitureId": "b000fe3e-e354-4868-a6e6-f282d8be9d50",
        "layerType": "furniture"
      },
      {
        "id": "cba708b6-0814-4d78-96a9-c48d0e7b922d",
        "name": "2C11",
        "furnitureId": "9e5e5f47-682c-41bf-b817-8cd2c0933c55",
        "layerType": "furniture"
      },
      {
        "id": "5120890d-86e5-48fd-b0c4-58ff014a5312",
        "name": "2C12",
        "furnitureId": "7956beae-3335-4ca2-88d1-f75ea4ab5c43",
        "layerType": "furniture"
      },
      {
        "id": "3908f14b-c6a7-4f0c-8b6d-d705c6f0e69e",
        "name": "2C13",
        "furnitureId": "3ca8bbe4-015b-4ab3-ad9b-0168ad010552",
        "layerType": "furniture"
      },
      {
        "id": "a53fce80-8e8e-4d41-bbf1-4cc12013f483",
        "name": "2C14",
        "furnitureId": "b5666417-21ef-4fec-99c0-9c492a633074",
        "layerType": "furniture"
      },
      {
        "id": "733e7731-094c-48d9-899a-1d25f5dfd75a",
        "name": "2C15",
        "furnitureId": "27e78ede-8a5c-45f9-b1b0-4f79aa47b9ba",
        "layerType": "furniture"
      },
      {
        "id": "d859b6e8-343a-4adc-9b94-f5ed0fa256f3",
        "name": "2A17",
        "furnitureId": "8a029e32-5149-42ce-a809-444f883efbf8",
        "layerType": "furniture"
      }
    ]
  },
  {
    "id": "cfdac053-2660-4602-9276-a1de71676bad",
    "name": "facilities_list",
    "type": "polygon",
    "assets": [
      {
        "id": "265a2bb7-1628-49f3-8fd5-d03aa7e139fa",
        "name": "Current Journals (2/F Zone A)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 15.297,
              "z": -54.13,
              "levelIndex": 0
            },
            {
              "x": 13.939,
              "z": -54.131,
              "levelIndex": 0
            },
            {
              "x": 13.964,
              "z": -45.375,
              "levelIndex": 0
            },
            {
              "x": 8.154,
              "z": -45.214,
              "levelIndex": 0
            },
            {
              "x": 8.213,
              "z": -43.36,
              "levelIndex": 0
            },
            {
              "x": 15.351,
              "z": -43.534,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "d2f045f3-5d74-4811-840e-58cdb20c91ae",
        "name": "Bound Journals (2/F Zone A)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 6.256,
              "z": -25.547,
              "levelIndex": 0
            },
            {
              "x": 6.297,
              "z": -35.322,
              "levelIndex": 0
            },
            {
              "x": 16.644,
              "z": -35.367,
              "levelIndex": 0
            },
            {
              "x": 16.487,
              "z": -25.483,
              "levelIndex": 0
            },
            {
              "x": 16.474,
              "z": -25.49,
              "levelIndex": 0
            },
            {
              "x": 6.268,
              "z": -25.511,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "35fd4b2c-5f00-4560-bfaf-c918f36751f0",
        "name": "Language Examinations & Learning Resources [LANG] (2/F Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 19.018,
              "z": -45.453,
              "levelIndex": 0
            },
            {
              "x": 19.013,
              "z": -46.98,
              "levelIndex": 0
            },
            {
              "x": 34.439,
              "z": -47.054,
              "levelIndex": 0
            },
            {
              "x": 34.455,
              "z": -45.473,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "f32c8fce-dad0-45f0-ab92-62b629eb672b",
        "name": "Lingnan University Archives (2/F Zone A)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": -2.637,
              "z": -56.219,
              "levelIndex": 0
            },
            {
              "x": -2.626,
              "z": -48.357,
              "levelIndex": 0
            },
            {
              "x": 6.409,
              "z": -48.384,
              "levelIndex": 0
            },
            {
              "x": 6.343,
              "z": -56.253,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "d3654080-7c4b-414c-a75c-d0b976cc52e2",
        "name": "Multimedia (2/F Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 46.614,
              "z": -25.822,
              "levelIndex": 0
            },
            {
              "x": 46.728,
              "z": -32.574,
              "levelIndex": 0
            },
            {
              "x": 53.969,
              "z": -32.602,
              "levelIndex": 0
            },
            {
              "x": 53.985,
              "z": -35.172,
              "levelIndex": 0
            },
            {
              "x": 55.182,
              "z": -35.224,
              "levelIndex": 0
            },
            {
              "x": 55.259,
              "z": -25.856,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "2cb77f88-3f4a-4608-b5ac-e7555a12bd4b",
        "name": "Current Issues (2/F Zone B)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 25.787,
              "z": -36.062,
              "levelIndex": 0
            },
            {
              "x": 25.819,
              "z": -37.466,
              "levelIndex": 0
            },
            {
              "x": 23.288,
              "z": -37.423,
              "levelIndex": 0
            },
            {
              "x": 23.283,
              "z": -35.994,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "e9b6409b-2421-476b-92f3-5e622123437a",
        "name": "Back Issues (2/F Zone A)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 8.234,
              "z": -43.412,
              "levelIndex": 0
            },
            {
              "x": 8.267,
              "z": -44.89,
              "levelIndex": 0
            },
            {
              "x": 13.396,
              "z": -45.005,
              "levelIndex": 0
            },
            {
              "x": 13.389,
              "z": -43.546,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "fd861d3b-b124-4a55-882a-248a319c6a04",
        "name": "References A-HM (2/F Zone A)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 15.622,
              "z": -48.155,
              "levelIndex": 0
            },
            {
              "x": 16.846,
              "z": -48.24,
              "levelIndex": 0
            },
            {
              "x": 16.815,
              "z": -54.367,
              "levelIndex": 0
            },
            {
              "x": 15.563,
              "z": -54.347,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "2983a1dc-8b11-4bec-bb97-b1ff214b6337",
        "name": "References HN-Z (2/F Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 44.252,
              "z": -47.685,
              "levelIndex": 0
            },
            {
              "x": 45.395,
              "z": -47.668,
              "levelIndex": 0
            },
            {
              "x": 45.439,
              "z": -53.851,
              "levelIndex": 0
            },
            {
              "x": 44.297,
              "z": -53.853,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "ba53551e-4c19-4a9e-9d88-55cb97d08781",
        "name": "Lee Hak Kan Multimedia and Language Learning Centre - MLLC (2/F Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 44.635,
              "z": -23.995,
              "levelIndex": 0
            },
            {
              "x": 46.258,
              "z": -23.949,
              "levelIndex": 0
            },
            {
              "x": 46.325,
              "z": -24.785,
              "levelIndex": 0
            },
            {
              "x": 53.642,
              "z": -24.885,
              "levelIndex": 0
            },
            {
              "x": 53.669,
              "z": -24.011,
              "levelIndex": 0
            },
            {
              "x": 55.295,
              "z": -24.07,
              "levelIndex": 0
            },
            {
              "x": 55.275,
              "z": -34.989,
              "levelIndex": 0
            },
            {
              "x": 65.383,
              "z": -35.035,
              "levelIndex": 0
            },
            {
              "x": 65.376,
              "z": -39.97,
              "levelIndex": 0
            },
            {
              "x": 55.24,
              "z": -40.067,
              "levelIndex": 0
            },
            {
              "x": 55.263,
              "z": -63.093,
              "levelIndex": 0
            },
            {
              "x": 51.408,
              "z": -63.07,
              "levelIndex": 0
            },
            {
              "x": 51.506,
              "z": -62.229,
              "levelIndex": 0
            },
            {
              "x": 44.988,
              "z": -58.294,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "d0bc7111-7fdb-41b2-99ce-6434721407bc",
        "name": "21, 22BW, 23 (2/F Zone A & Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 44.513,
              "z": -37.569,
              "levelIndex": 0
            },
            {
              "x": 46.53,
              "z": -37.473,
              "levelIndex": 0
            },
            {
              "x": 46.565,
              "z": -34.053,
              "levelIndex": 0
            },
            {
              "x": 44.507,
              "z": -34.061,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "7d29c189-455f-4ac9-927b-75264829d3fe",
        "name": "21, 22BW, 23 (2/F Zone A & Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 6.316,
              "z": -43.915,
              "levelIndex": 0
            },
            {
              "x": 8.016,
              "z": -43.883,
              "levelIndex": 0
            },
            {
              "x": 8.038,
              "z": -40.777,
              "levelIndex": 0
            },
            {
              "x": 6.305,
              "z": -40.785,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "0a491f46-ea57-4674-b494-8a2ecb513adf",
        "name": "Group Study Room 10 - 11 (2/F Zone B)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 16.503,
              "z": -40.08,
              "levelIndex": 0
            },
            {
              "x": 16.527,
              "z": -34.431,
              "levelIndex": 0
            },
            {
              "x": 23.57,
              "z": -34.314,
              "levelIndex": 0
            },
            {
              "x": 38.814,
              "z": -34.364,
              "levelIndex": 0
            },
            {
              "x": 44.563,
              "z": -34.342,
              "levelIndex": 0
            },
            {
              "x": 44.609,
              "z": -39.962,
              "levelIndex": 0
            },
            {
              "x": 37.862,
              "z": -37.178,
              "levelIndex": 0
            },
            {
              "x": 37.91,
              "z": -34.374,
              "levelIndex": 0
            },
            {
              "x": 23.311,
              "z": -34.311,
              "levelIndex": 0
            },
            {
              "x": 23.338,
              "z": -37.048,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "6adfc182-439f-41c2-8789-361fdba793cd",
        "name": "Chang Han-tsiu Reading Room (2/F Zone A)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 6.332,
              "z": -35.489,
              "levelIndex": 0
            },
            {
              "x": 16.707,
              "z": -35.532,
              "levelIndex": 0
            },
            {
              "x": 16.324,
              "z": -58.271,
              "levelIndex": 0
            },
            {
              "x": 9.957,
              "z": -62.537,
              "levelIndex": 0
            },
            {
              "x": 9.973,
              "z": -63.172,
              "levelIndex": 0
            },
            {
              "x": 6.337,
              "z": -63.177,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "e0d95117-64aa-428d-8bde-d331fa064d54",
        "name": "Lee Hak Kan Multimedia and Language Learning Centre - MLLC (2/F Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 51.444,
              "z": -63.107,
              "levelIndex": 0
            },
            {
              "x": 55.368,
              "z": -63.162,
              "levelIndex": 0
            },
            {
              "x": 55.225,
              "z": -23.96,
              "levelIndex": 0
            },
            {
              "x": 53.662,
              "z": -24.053,
              "levelIndex": 0
            },
            {
              "x": 53.655,
              "z": -24.748,
              "levelIndex": 0
            },
            {
              "x": 46.326,
              "z": -24.863,
              "levelIndex": 0
            },
            {
              "x": 46.305,
              "z": -23.968,
              "levelIndex": 0
            },
            {
              "x": 44.547,
              "z": -23.872,
              "levelIndex": 0
            },
            {
              "x": 44.893,
              "z": -58.33,
              "levelIndex": 0
            },
            {
              "x": 51.405,
              "z": -62.351,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "a92937ea-f520-4045-b98a-edb1dc3be071",
        "name": "Mini Theatre (2/F Zone B)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 23.231,
              "z": -34.404,
              "levelIndex": 0
            },
            {
              "x": 23.23,
              "z": -37.195,
              "levelIndex": 0
            },
            {
              "x": 16.509,
              "z": -39.941,
              "levelIndex": 0
            },
            {
              "x": 16.513,
              "z": -42.436,
              "levelIndex": 0
            },
            {
              "x": 23.972,
              "z": -42.42,
              "levelIndex": 0
            },
            {
              "x": 23.895,
              "z": -45.763,
              "levelIndex": 0
            },
            {
              "x": 37.489,
              "z": -45.881,
              "levelIndex": 0
            },
            {
              "x": 37.444,
              "z": -42.471,
              "levelIndex": 0
            },
            {
              "x": 44.618,
              "z": -42.488,
              "levelIndex": 0
            },
            {
              "x": 44.602,
              "z": -39.925,
              "levelIndex": 0
            },
            {
              "x": 37.855,
              "z": -37.09,
              "levelIndex": 0
            },
            {
              "x": 37.905,
              "z": -34.412,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "f738d6e8-1f42-4be7-8bd8-2398ebbb4d49",
        "name": "2/F (2/F Zone A)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 6.397,
              "z": -37.15,
              "levelIndex": 0
            },
            {
              "x": 7.539,
              "z": -37.145,
              "levelIndex": 0
            },
            {
              "x": 7.545,
              "z": -35.697,
              "levelIndex": 0
            },
            {
              "x": 6.353,
              "z": -35.705,
              "levelIndex": 0
            },
            {
              "x": 6.356,
              "z": -36.331,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "80339a7e-458a-4b8d-96a5-8dc106e59c28",
        "name": "2/F Male (Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 59.91,
              "z": -35.025,
              "levelIndex": 0
            },
            {
              "x": 59.919,
              "z": -38.009,
              "levelIndex": 0
            },
            {
              "x": 65.323,
              "z": -37.957,
              "levelIndex": 0
            },
            {
              "x": 65.345,
              "z": -35,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "af0a79b4-e8d5-4362-891a-818391977191",
        "name": "Lift (2/F Zone B)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 38.093,
              "z": -45.815,
              "levelIndex": 0
            },
            {
              "x": 38.019,
              "z": -48.876,
              "levelIndex": 0
            },
            {
              "x": 42.247,
              "z": -48.881,
              "levelIndex": 0
            },
            {
              "x": 42.229,
              "z": -45.899,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "034e6926-21b5-4670-8286-c070910d7f2c",
        "name": "21, 22BW, 23 (2/F Zone A & Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 55.312,
              "z": -44.414,
              "levelIndex": 0
            },
            {
              "x": 52.741,
              "z": -44.416,
              "levelIndex": 0
            },
            {
              "x": 52.737,
              "z": -46.224,
              "levelIndex": 0
            },
            {
              "x": 55.326,
              "z": -46.229,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      },
      {
        "id": "b7ce6086-3918-4423-9532-d405a17aa481",
        "name": "2/F Female (Zone C)",
        "levelIndex": 0,
        "coordinates": [
          [
            {
              "x": 55.364,
              "z": -35.023,
              "levelIndex": 0
            },
            {
              "x": 55.398,
              "z": -38.003,
              "levelIndex": 0
            },
            {
              "x": 59.919,
              "z": -38.038,
              "levelIndex": 0
            },
            {
              "x": 59.924,
              "z": -34.994,
              "levelIndex": 0
            }
          ]
        ],
        "layerType": "polygon",
        "mapped": true
      }
    ]
  }
];

      // Space class to handle the Smplrspace viewer and data
      class Space {
        constructor(spaceId, clientToken, toilets, nonAccessibleArea, rooms) {
          this.spaceId = spaceId;
          this.clientToken = clientToken;
          this.space = null;
          this.toilets = toilets;
          this.nonAccessibleArea = nonAccessibleArea;
          this.rooms = rooms;

        }

        initSpace(smplr) {
  this.space = new smplr.Space({
    spaceId: this.spaceId,
    clientToken: this.clientToken,
    containerId: "smplrspace-container",
  });
  this.space.startViewer({
    preview: false,
    allowModeChange: true,
    disableCameraRotation: true,
     loadingMessage: "Loading...",
    cameraPlacement: {
      alpha: -1.5722224976673886,
      beta: 0.22438049962679768,
      radius: 151.566640313453746,
      target: {
        x: 30.2418383712391,
        y: 14,
        z: -48.20580854095632,
      },
    },
    onReady: () => {
      this.updateDataLayers();
      // Check for facility parameter after space is ready
      const params = new URLSearchParams(window.location.search);
      const facility = params.get("facility");
      if (facility && this.rooms && this.rooms.length > 0) {
        // Focus camera on the facility if it exists
        const facilityRooms = this.rooms.filter(r => r.name === facility);
const facilityRoom = facilityRooms.length > 0 ? facilityRooms[0] : null;
        if (facilityRoom && facilityRoom.coordinates) {
          // Calculate center of facility for camera positioning
          // You may need to adjust these values based on your space
          this.space.setCameraPlacement({
            alpha: -1.5722224976673886,
            beta: 0.22438049962679768,
            radius: 80, // Zoom in closer
            target: {
              x: facilityRoom.coordinates[0][0].x,
              y: 14,
              z: facilityRoom.coordinates[0][0].z,
            },
          });
        }
      }
    },
    onError: (error) => console.error("Could not start viewer", error),
  });
}

        updateDataLayers() {
  // Remove previous layers if any
  this.space.removeDataLayer("toilets");
  this.space.removeDataLayer("nonAccessibleArea");
  this.space.removeDataLayer("rooms");

  const isToiletsEmpty = !this.toilets || this.toilets.length === 0;
  const isNonAccessibleAreaEmpty = !this.nonAccessibleArea || this.nonAccessibleArea.length === 0;
  const isRoomsEmpty = !this.rooms || this.rooms.length === 0;

  if (!isToiletsEmpty) {
    this.space.addDataLayer({
      id: "toilets",
      type: "polygon",
      data: this.toilets,
      tooltip: (d) => {
        const isFemale = d.name.includes("FT");
        return `${isFemale ? "Female Toilet" : "Male Toilet"}`;
      },
      color: (d) => d.color || "#AED6F1",
      alpha: 4.9,
      height: 1.0,
    });
  }

  if (!isNonAccessibleAreaEmpty) {
    this.space.addDataLayer({
      id: "nonAccessibleArea",
      type: "polygon",
      data: this.nonAccessibleArea,
      tooltip: (d) => "Not Accessible",
      color: (d) => d.color || color_dict.restricted,
      alpha: 2.2,
      height: 1.0,
    });
  }

  if (!isRoomsEmpty) {
    this.space.addDataLayer({
      id: "rooms",
      type: "polygon",
      data: this.rooms,
      color: (d) => d.color,
      alpha: 2.2,
      height: (d) => d.height || 2.4,
    });
  }

  // ============ FACILITY ICONS SECTION - START ============
  
  console.log("Checking for facilities with icons...");
  
  // Array to hold all icon data
  const iconData = [];
  
  // Define icon configurations by facility ID for 2F
  const iconConfigs = {
    "d0bc7111-7fdb-41b2-99ce-6434721407bc": "./icons/21, 22BW, 23 (2F Zone A & Zone C)_c.png",
    "7d29c189-455f-4ac9-927b-75264829d3fe": "./icons/21, 22BW, 23 (2F Zone A & Zone C)_c.png",
    "034e6926-21b5-4670-8286-c070910d7f2c": "./icons/21, 22BW, 23 (2F Zone A & Zone C)_c.png",

    "265a2bb7-1628-49f3-8fd5-d03aa7e139fa": "./icons/Current Issues (2F Zone B).png",

    "ba53551e-4c19-4a9e-9d88-55cb97d08781": "./icons/For all entries under Computers.png",
    "e0d95117-64aa-428d-8bde-d331fa064d54": "./icons/For all entries under Computers.png",


  };
  
 // Filter for ALL facilities that have an icon configured (by ID)
const facilitiesWithIcons = this.rooms && this.rooms.filter(room => 
  iconConfigs.hasOwnProperty(room.id)
);

console.log("Facilities with icons found:", facilitiesWithIcons ? facilitiesWithIcons.length : 0);

if (facilitiesWithIcons && facilitiesWithIcons.length > 0) {
  console.log(`Adding icons for ${facilitiesWithIcons.length} facilities`);
  
  facilitiesWithIcons.forEach(facility => {
    // Get the icon URL for this specific facility ID
    const iconUrl = iconConfigs[facility.id];
    
    if (iconUrl && facility.coordinates && facility.coordinates[0]) {
      // Get polygon coordinates
      const coords = facility.coordinates[0];
      
      // Calculate center X (average of all x coordinates)
      const centerX = coords.reduce((sum, coord) => sum + coord.x, 0) / coords.length;
      
      // Find TOP EDGE (minimum z value = northernmost point)
      const minZ = Math.min(...coords.map(coord => coord.z));
      
    iconData.push({
        id: `icon-${facility.id}`,
        levelIndex: 0,
        position: {
          x: centerX + 0.1 ,
          z: minZ + 2.6, 
          elevation: 4.0,
          levelIndex: 0
        }
      });
      
      console.log(`  Icon added for facility ${facility.id} (${facility.name}): x=${centerX.toFixed(2)}, z=${(minZ - 2.5).toFixed(2)}`);
    }
  });
}
  
  // Add the icon layer if there's any icon data
  if (iconData.length > 0) {
    try {
      // Group by icon URL for separate layers
      const iconsByUrl = {};
      
      facilitiesWithIcons.forEach(facility => {
        const iconUrl = iconConfigs[facility.id];
        if (iconUrl) {
          if (!iconsByUrl[iconUrl]) {
            iconsByUrl[iconUrl] = [];
          }
          // Find the corresponding icon data
          const iconDataItem = iconData.find(item => item.id === `icon-${facility.id}`);
          if (iconDataItem) {
            iconsByUrl[iconUrl].push(iconDataItem);
          }
        }
      });
      
      // Create a layer for each unique icon
      Object.entries(iconsByUrl).forEach(([iconUrl, icons], layerIndex) => {
        this.space.addDataLayer({
          id: `facility-icons-${layerIndex}`,
          type: "icon",
          data: icons,
          icon: {
            url: iconUrl,
            width: 2000,
            height: 2000
          },
          width: 5.0
        });
      });
      
      console.log(`✓ Icon layer(s) added successfully! Total icons: ${iconData.length}`);
    } catch (error) {
      console.error("✗ Error adding icon layer:", error);
    }
  } else {
    console.log("⚠ No facility icons to display");
  }
  // ============ FACILITY ICONS SECTION - END ============

  // Add click handlers for custom tooltip
this.space.on("click", (event) => {
  if (event.data) {
    const tooltipDiv = document.getElementById("custom-tooltip");
    const contentDiv = document.getElementById("tooltip-content");

    if (event.data.name && tooltipDiv && contentDiv) {
      showGenericTooltip(event.data.name, true); // Use the centralized function with skeleton loading
    }
  }
});
}

updateMapForFacility() {
  this.updateDataLayers();
}
      }

      const toilet_assets = [];

      // Initialize non-accessible area with red color
      const nonAccessibleArea_assets = dict[0]["assets"].map((area) => {
        return {
          ...area,
          available: "restricted",
          color: color_dict["restricted"],
        };
      });

      // Create the Space instance
      let spc = new Space(
        SPACE_ID,
        CLIENT_ID,
        toilet_assets,
        nonAccessibleArea_assets, rooms
      );

      // delete dict;

      async function wait() {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve();
          }, 500);
        });
      }

      async function start() {
  while (typeof smplr === "undefined") {
    await wait();
  }
  
  // Fetch facility data first
  await fetchFacilityData();
  
  spc.initSpace(smplr);
  
  const currentUrl = window.location.href;
  const url = new URL(currentUrl);
  const params = new URLSearchParams(url.search);
  const facility = params.get("facility");
  
  if (!!facility) {
  // Wait for space to be ready
  setTimeout(() => {
    const facilitiesData = dict[4];
    // Get ALL facilities with the same name using filter()
    let facilityAssets = facilitiesData.assets.filter(asset => asset.name === facility);
    
    if (facilityAssets.length > 0) {
      // Handle all matched facilities
      facilityAssets.forEach(facilityAsset => {
        handleGenericFacility(facilityAsset, facility);
      });
    } else {
      console.log('Facility coordinates not found, will show tooltip only');
      setTimeout(() => showGenericTooltip(facility), 2500);
    }
  }, 1000);
}
}
      start();
    </script>

  </body>
</html>
