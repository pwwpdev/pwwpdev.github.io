<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Second Floor Smplrspace Viewer</title>
  </head>
  <body>
    <script src="https://app.smplrspace.com/lib/smplr.js"></script>
    <link href="https://app.smplrspace.com/lib/smplr.css" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <div id="wrapper">
      <div id="smplrspace-container" class="gap"></div>
    </div>

    <script>
      const API_ENDPOINT =
        "https://optimusc.flowfuse.cloud/lingnan-library-dos";

      const CLIENT_ID = "pub_45cf413215bd43f79621e0b28f8a815b";
      const SPACE_ID = "spc_v2qssnrl";

      const UPDATE_FREQUENCY = 60;

      // Keep non-accessible area index
      const non_accessible_area_index = {
        "1": 0,
        "2": 1,
        "3": 2,
        "4": 3,
        "5": 4
      };

      // Filter for non-accessible areas
      const non_accessible_area_filter = {
        "1": "1",
        "2": "2",
        "3": "3",
        "4": "4",
        "5": "5"
      };

      const color_dict = {
        occupied: "#ff3f34",
        countdown: "#ff3f34",
        vacant: "#3aa655",
        free: "#3aa655",
        unoccupied: "#3aa655",
        passive_occupied: "#ffbf00",
        away: "#ffbf00",
        demo: "#6888be",
        unavailable: "#949494",
        restricted: "#768590",
      };

      // Non-accessible area data
      const nonAccessibleAreaData = {
        "id": "2e95877e-f91c-4a3b-b6c4-7eb1281ed8d4",
        "name": "NonAssessibleArea",
        "type": "polygon",
        "assets": [
          {
            "id": "57ea7aa9-ae01-4590-a2a8-2e4fcfd8693f",
            "name": "1",
            "levelIndex": 0,
            "coordinates": [
              {
                "x": 68.32956289771808,
                "z": -41.17089608217181,
                "levelIndex": 0
              },
              {
                "x": 68.21073716331547,
                "z": -48.68131204892148,
                "levelIndex": 0
              },
              {
                "x": 77.36742725207854,
                "z": -48.58309216764699,
                "levelIndex": 0
              },
              {
                "x": 77.6114752014466,
                "z": -41.41165491730443,
                "levelIndex": 0
              }
            ],
            "layerType": "polygon",
            "mapped": true
          },
          {
            "id": "25ff2879-8cdd-4862-b74d-34ba861bc3c0",
            "name": "2",
            "levelIndex": 0,
            "coordinates": [
              {
                "x": 50.044476703660806,
                "z": -41.23369670412247,
                "levelIndex": 0
              },
              {
                "x": 50.072399106646,
                "z": -46.924584976818224,
                "levelIndex": 0
              },
              {
                "x": 61.206211058006375,
                "z": -46.99810934362567,
                "levelIndex": 0
              },
              {
                "x": 61.04446277394342,
                "z": -41.20628910259305,
                "levelIndex": 0
              }
            ],
            "layerType": "polygon",
            "mapped": true
          },
          {
            "id": "7096e5ec-9195-4120-80b7-e12cd072c308",
            "name": "3",
            "levelIndex": 0,
            "coordinates": [
              {
                "x": -0.4148542187773714,
                "z": -41.43034932362043,
                "levelIndex": 0
              },
              {
                "x": -0.5608730869583809,
                "z": -46.979858017539016,
                "levelIndex": 0
              },
              {
                "x": 8.642534083266085,
                "z": -46.73210388315975,
                "levelIndex": 0
              },
              {
                "x": 8.421777201450201,
                "z": -41.29722680694566,
                "levelIndex": 0
              }
            ],
            "layerType": "polygon",
            "mapped": true
          },
          {
            "id": "7eddaca0-1c0f-4dd7-97dd-8475c95cf139",
            "name": "4",
            "levelIndex": 0,
            "coordinates": [
              {
                "x": -13.881517090392148,
                "z": -41.49116627830768,
                "levelIndex": 0
              },
              {
                "x": -5.374512892676876,
                "z": -41.5213242541602,
                "levelIndex": 0
              },
              {
                "x": -5.395558332093825,
                "z": -41.76897173716827,
                "levelIndex": 0
              },
              {
                "x": -5.336164756068307,
                "z": -47.99344509416271,
                "levelIndex": 0
              },
              {
                "x": -13.822942336672895,
                "z": -47.9277166938746,
                "levelIndex": 0
              }
            ],
            "layerType": "polygon",
            "mapped": true
          },
          {
            "id": "1a3d37e4-2696-4552-9309-7e4faae46e29",
            "name": "5",
            "levelIndex": 0,
            "coordinates": [
              {
                "x": 72.41863968879858,
                "z": -63.0780507895337,
                "levelIndex": 0
              },
              {
                "x": 72.28129050451366,
                "z": -63.51937986144018,
                "levelIndex": 0
              },
              {
                "x": 72.40921387252835,
                "z": -63.063649028587676,
                "levelIndex": 0
              },
              {
                "x": 72.35661853946851,
                "z": -66.87407896096673,
                "levelIndex": 0
              },
              {
                "x": 67.3186923251089,
                "z": -66.84022704780462,
                "levelIndex": 0
              },
              {
                "x": 67.16558802109795,
                "z": -65.85840399442287,
                "levelIndex": 0
              },
              {
                "x": 58.49594424883006,
                "z": -65.79752227067453,
                "levelIndex": 0
              },
              {
                "x": 58.38015257543433,
                "z": -62.95781121210062,
                "levelIndex": 0
              },
              {
                "x": 60.748083445841914,
                "z": -62.08173915625558,
                "levelIndex": 0
              },
              {
                "x": 64.86325173495962,
                "z": -62.123783459958936,
                "levelIndex": 0
              },
              {
                "x": 67.3587856783585,
                "z": -63.15343343903772,
                "levelIndex": 0
              }
            ],
            "layerType": "polygon",
            "mapped": true
          }
        ]
      };

      // Space class to handle the Smplrspace viewer and data
      class Space {
        constructor(spaceId, clientToken, nonAccessibleArea) {
          this.spaceId = spaceId;
          this.clientToken = clientToken;
          this.space = null;
          this.nonAccessibleArea = nonAccessibleArea;
        }

        initSpace(smplr) {
          this.space = new smplr.Space({
            spaceId: this.spaceId,
            clientToken: this.clientToken,
            containerId: "smplrspace-container",
          });
          this.space.startViewer({
            preview: false,
            cameraPlacement: {
              alpha: -1.5726702585685455,
              beta: 0.39278097218549923,
              radius: 79.02889993229235,
              target: {
                x: 44,
                y: 1,
                z: -51,
              },
            },
            onReady: () => this.updateDataLayers(),
            onError: (error) => console.error("Could not start viewer", error),
          });
        }

        updateDataLayers() {
          // Remove previous layers if any
          this.space.removeDataLayer("nonAccessibleArea");

          const isNonAccessibleAreaEmpty =
            !this.nonAccessibleArea || this.nonAccessibleArea.length === 0;

          if (!isNonAccessibleAreaEmpty) {
            this.space.addDataLayer({
              id: "nonAccessibleArea",
              type: "polygon",
              data: this.nonAccessibleArea,
              tooltip: (d) => `${d.name} - Not Accessible`,
              color: (d) => d.color || color_dict.restricted,
              alpha: 2.2,
              height: 2.9,
            });
          }
        }
      }

      // Initialize non-accessible area assets with the new JSON structure
      const nonAccessibleArea_assets = nonAccessibleAreaData.assets.map((area, index) => {
        // Map each area to its index in the non_accessible_area_index object
        const areaName = area.name;
        return {
          ...area,
          // Use the index from non_accessible_area_index if available
          index: non_accessible_area_index[areaName] !== undefined ? 
                 non_accessible_area_index[areaName] : index,
          available: "restricted",
          color: color_dict["restricted"],
        };
      });

      // Create the Space instance with only non-accessible areas
      let spc = new Space(
        SPACE_ID,
        CLIENT_ID,
        nonAccessibleArea_assets
      );

      async function wait() {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve();
          }, 500);
        });
      }

      async function start() {
        while (typeof smplr === "undefined") {
          await wait();
        }
        spc.initSpace(smplr);
      }

      start();
    </script>
  </body>
</html>
